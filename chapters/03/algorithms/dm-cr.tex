\begin{algorithm}[H]
\DontPrintSemicolon
\SetKwComment{comment}{$\%$}{}
\SetKw{Int}{int}
\SetKw{To}{to}
\SetKw{Return}{return}
\SetKw{Not}{not}
\SetKw{Input}{Input}
\SetKw{Output}{Output}
\SetKwData{Item}{item}
\SetKwFunction{Min}{min}
\SetKwFunction{TitleFunction}{Direct Method with Composition-Rejection Search}

\caption{\protect\TitleFunction{}}
\label{algo:dm-cr}

\Input: a biochemical reaction network of $M$ reactions in which each reaction $R_j$, $j=1, \dots, M$ is accompanied with the state change vector $\vec{v}_j$ and the propensity $a_j$, the initial state $\vec{x}_0$ at time $0$ and the simulation ending time $T_{\max}$\;

\Output: a trajectory of the biochemical reaction network, which is a collection of states $X(t)$ for time $0\le t\le T_{\max}$\;

$t = 0$\;
$\vec{X} = \vec{x}_0$\;
build the dependency graph $G$\;
partition $M$ reactions into $L$ groups $\{G_1, \dots, G_L\}$ such that $R_j\in G_l$ if $2^{u_l-1}\le a_j\le 2^{u_l}$\;

$a_0 = 0$\;

\ForEach{$G_l$}{
	$a^l = 0$\;
	\ForEach{$R_j\in G_l$}{
		compute $a_j$\;
		$a^l = a^l + a_j$\;
	}
	$a_0 =a_0 + a^l$\;
}

\While{$t<T_{\max}$}{
	generate a random number $r_1\sim norm(0,1)$\;
	select $G_\alpha$ with the smalles group index $\alpha$ such that $\sum\limits_{l=1}^\alpha a^l\ge r_1a_0$\;

	\Repeat{$r_2\le \frac{a_\mu}{2^{u_\alpha}}$}{
		generate a random number $r_2\sim norm(0,1)$\;
		$\mu = [r_2|G_\alpha|]$\;
		$r_2 = r_2|G_\alpha|-\mu$\;
	}
	generate a random number $r_3\sim norm(0,1)$\;
	$\tau = \frac{1}{a_0}\ln\frac{1}{r_2}$\;
	$\vec{X} = \vec{X}+\vec{v}_\mu$\;
	$t=t+\tau$\;
	\ForEach{$R_j\in Dependents(R_\mu)$}{
		update $a_j$\;
		\If{$a_j\not\in[2^{u_l-1},2^{u_l}]$}{
			move $R_j$ from $G_l$ to an appropriate $G_m$\;
			updated $a^l$ and $a^m$\;
		}
		\Else{
			update $a^l$\;
		}
		update $a_0$\;
	}
}

\end{algorithm}
