\begin{algorithm}[H]
\DontPrintSemicolon
\SetKwComment{comment}{$\%$}{}
\SetKw{Int}{int}
\SetKw{To}{to}
\SetKw{Return}{return}
\SetKw{Not}{not}
\SetKw{Input}{Input}
\SetKw{Output}{Output}
\SetKwData{Item}{item}
\SetKwFunction{Min}{min}
\SetKwFunction{TitleFunction}{Next Reaction Method (NRM)}

\caption{\protect\TitleFunction{}}
\label{algo:nrm}

\Input: a biochemical reaction network of $M$ reactions in which each reaction $R_j$, $j=1, \dots, M$ is accompanied with the state change vector $\vec{v}_j$ and the propensity $a_j$, the initial state $\vec{x}_0$ at time $0$ and the simulation ending time $T_{\max}$\;

\Output: a trajectory of the biochemical reaction network, which is a collection of states $X(t)$ for time $0\le t\le T_{\max}$\;

$t = 0$\;
$\vec{X} = \vec{x}_0$\;
build the reaction dependency graph $G$\;

\ForEach{$R_j$}{
	compute $a_j$\;
	generate a random number $r_j\sim norm(0,1)$\;
	$t_j = \frac{1}{a_j}\ln\left(\frac{1}{r_j}\right)$\;
}

build the binary heap $H$ for $M$ tentative times $t_j$\;

\While{$t<T_{\max}$}{
	extract the node with smallest $t_\mu$ and reaction $R_\mu$ from $H$\;
	$t = t_\mu$\;
	$\vec{X} = \vec{X}+\vec{v}_\mu$\;
	\ForEach{$R_j\in Dependents(R_\mu)$}{
		compute $a_j^{new}$\;
		\If{$j\neq\mu$}{
			$t_j = \frac{a_j}{a_j^{new}}(t_j-t)+t$\;
		}
		\ElseIf{$j=\mu$}{
			generate a random number $r\sim norm(0,1)$\;
			$t_\mu = t+\frac{1}{a_\mu^{new}}\ln\frac{1}{r}$\;
		}
		$a_j = a_j^{new}$\;
		replace the old time $t_j$ in $H$ with the new value $t_j^{new}$ and maintain the heap $H$\;
	}
}

\end{algorithm}
