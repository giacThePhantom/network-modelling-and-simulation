\graphicspath{{chapters/02/images/}}
\chapter{Stochastic simulation of biochemical reaction systems}

\section{Introduction}
Biochemical reaction network can be modelled through stochastic chemical kinetics.
In this type of models the discreteness in population of species and the randomness of reactions are treated as an intrinsic part.
The dynamical behaviour is described by the chemical master equation or CME.

\section{Stochastic chemical kinetics}

  \subsection{Rewriting biochemical reactions}
  Biochemical reactions are the building blocks to model biological systems.
  They provide a unifying notation with sufficient level of details to represent complex biological processes.
  Biochemical reactions decorated with reaction kinetics can be simulated by a simulation algorithm to generate a realization of their dynamics.
  Chemical species in a biological system move around and gain kinetic energy.
  Upon collisions with other species, they undergo reactions to modify and transform into different species.

    \subsubsection{Representing molecular reactions}
    Molecular reactions can be classified between elementary reactions and non-elementary ones.
    The former require one step to complete, while the latter require a higher order reactions or a multi-step one.

      \paragraph{Some elementary reactions}

        \subparagraph{Unimolecolar reaction}
        An unimolecolar reaction involves the transformation of one species into another.
        It can be represented as:

        $$A\rightarrow B$$

        \subparagraph{Degradation}
        The degradation of a species is a special type of an unimolecolar reaction in which a species is degradated:

        $$A\rightarrow\emptyset$$

        Where the symbol $\emptyset$ represents a species that is not considered in the model, probably because it is large and does not change over time.

        \subparagraph{Synthesis}
        The synthesis of a species is another type of unimolecolar reaction in which a species is synthesised:

        $$\emptyset\rightarrow A$$

        This reaction is used to model the effects of the outside environment on system dynamics.

        \subparagraph{Bimolecular reaction}
        An example of a bimolecular reaction is an association reaction, in which a molecule can associated with another to produce a complex:

        $$A+B\rightarrow C$$

        Often this process is reversible and the inverse dissociation reaction can take place:

        $$A+B\xleftrightharpoons[]{} C$$

        \subparagraph{Dimerization}
        The dimerization is a special bimolecular reaction in which two molecules of the same species are consumed to produce another species:

        $$2A\rightarrow B$$

      \paragraph{Some non-elementary reactions}

        \subparagraph{Termolecular reaction}
        The termolecular reaction is used to represent the polymerization of three molecules into another species.
        The original molecules can be of the same species:

        $$3A\rightarrow B$$

        Or of two different species:

        $$2A +B\rightarrow C$$

        \subparagraph{Enzymatic reaction}
        Another multi-step reaction is an enzymatic reaction, where the enzyme $E$ that catalyses the rate of conversion is kept the same:

        $$A+E\rightarrow B+E$$

    \subsubsection{Equation-based methods}
    The previous way to represent reactions does not give insight on the function of the equation.
    To shine light on this aspect equation-based methods need to be applied, like ordinary differential equation systems.
    In these the derivative with respect to time is specified for any of the variables in term of a function of the state.
    It can be noted how the stochastic simulation approach can be approximated by a deterministic one.

    \subsubsection{Creating a formal mathematical description of a biological system}
    To write a mathematical description of a biological system there is a need to:

    \begin{enumerate}
      \item Choose the biochemical reactions' representation.
      \item Choose the type of variable to describe the state of the system.
      \item Specify the likelihood of execution for each reaction.
    \end{enumerate}

    A reaction will be faster when there is a huge amount of reactants.
    This is because in term of probability, the more a species is present, the more it is likely to interact and for the reaction is to happen.
    This is true only when the assumption of that there is a well-mixed reaction volume is made.
    This assumption entails that the distribution of molecules is uniform.
    Moreover, in order to approximate a complex system the main compartments can be partitioned in smaller sets where a discretization procedure can be applied.
    Therefore in this case Petri nets are a suitable representation for these kind of systems.

    \subsubsection{Well-mixed reaction volume}
    A well-mixed reaction volume is a reaction volume in which all the molecular species are homogeneously distributed and spatially indistinguishable.
    This is legitimate as non-reactive conditions are much more frequent than reactive ones.
    The biochemical reaction system with well-mixed volume thus satisfies the spatial homogeneity condition, where spatial distribution of molecular species can be ignored.
    Chemical species under the well-mixed assumption at a thermal equilibrium are uniformly distributed in the volume $V$ and their velocities are thermally randomized according to the Maxwell-Boltzmann distribution.

    \subsubsection{Formal representation}
    The state of a spatially homogeneous biological system is determined by the population of each species, while the position and velocity of each individual molecule are ignored.
    Let $X_i(t)$ be the population of species $S_i$ at a particular time $t$.
    The N-vector $X(t) = (X_1(t),...,X_N(t))$, which determines the population of each species, constitutes the system state at the time $t$.
    Chemical species interact through $M$ reactions $R_1, \dots, R_M$.
    A general reaction $R_j$ has a general scheme:

    $$v^-_{j1}S_1+...+v^-_{jN}S_N \rightarrow v^+_{j1}S_1+...+v^-_{jN}S_N$$

    Where:

    \begin{multicols}{2}
      \begin{itemize}
        \item Species on the left side are reactants.
        \item Species on the right side are products.
        \item The non-negative integers $v^-_{ji}$ and $v^+_{ji}$ are the stoichiometric coefficients which denote the number of molecules of a reactant that are consumed and the number of molecules of a product that are produced.
      \end{itemize}
    \end{multicols}

    A reactant species that affects the speed of a reaction but is not consumed by it is called a catalyst.
    The sum of stoichiometric coefficients of reactants of a reaction $R_j$ is called reaction order.
    For each reaction $R_j$, the net change in the population of species $S_i$ involved in the reaction is equal to $v^+_{ji}-v^-_{ji}$, which can be positive, negative or zero.

    \subsubsection{Stoichiometric matrix}
    The net changes by all reactions are described by a stoichiometry matrix $\vec{v}$ of size $M × N$.
    The \emph{j}th row $\vec{v}_j$ of the stoichiometry matrix expresses the changes caused by reaction $R_j$ and it is called the state change vector.
    Different system can lead to the same stoichiometric matrix.
    To describe a reaction two matrices are required:

    \begin{multicols}{2}
      \begin{itemize}
        \item $V^+$ provides the products.
        \item $V^-$ provides the reactants.
      \end{itemize}
    \end{multicols}

    $$ V^- = \begin{bmatrix}1 & 1 & 0 \\ 0 & 1&1 \\ 1&0&1 \end{bmatrix}, V^+ = \begin{bmatrix}0 & 2 & 0 \\ 0 & 0&2 \\ 2&0&0 \end{bmatrix}, V = \begin{bmatrix}1 & 1 & 0 \\ 0 & -1&1 \\ 1&0&-1 \end{bmatrix}\\ V = V^+ + V^- $$

    Suppose that at a time $t$ the state, or number of molecules in that given moment is $X(t)$.
    It is further assumed that the next reaction scheduled to fire at the next time $t + \tau$ is $R _\mu$, which move the system accordingly to a new state $X(t + \tau)$.
    $\vec{x}$ is a simple notation to represent $X(t)$.
    Two important assumptions are made for the transition from state $X(t)$ to state $X(t+\tau)$:

    \begin{multicols}{2}
      \begin{itemize}
        \item No changes occur in the system state during the time interval $[t, t+\tau[$, before the next reaction fires.
        \item The reaction occurs instantly after it is initiated.
      \end{itemize}
    \end{multicols}

    These are called the Markov property.
    So the evolution of the system in a time step will be:

    $$ X(t+\tau) = X(t)+v_\mu $$

    \subsubsection{Summary}
    While specifying in computational terms the biological system of interest, the structure of at least one compartment has to be described, where it is assumed to find a chemical volume in which there are some entities that interact with each other.
    The well-mixed volume preliminary assumption is enforced, meaning that all the actors are present with equal availability in all the parts of the volume.
    For each compartment, the entities or how many molecules are available, and the reactions that provide the rules for transforming the chemicals in others along the time have to be specified.
    All these structures of reactions can be defined in mathematical terms using matrices: the number of columns is equal to the number of variables, while the number of rows is equal to the number of reactions and the stoichiometric coefficient of the transformation from reactant to products is specified.

  \subsection{Reaction propensity}
  Each reaction in stochastic chemical kinetics is considered as a \emph{stochastic process} where each of its occurrences is a random event with an assigned probability distribution.
  It is impossible to predict the progress of reactions deterministically, but only stochastically with a probability.
  The propensity of a reaction is a formula that is computed on a state of a system.
  Through the reaction propensity the probability of execution of a reaction will be hinted.

    \subsubsection{Definition}
    The propensity $a_j$ of a reaction $R_j$ is defined such that $a_j(\vec{x})dt$ is the probability that a reaction $R_j$ fires in the next infinitesimal time interval $[t, t+dt[$, given the state $X(t) = \vec{x}$ at time $t$.
  In a chemical setting, the probability of execution of one reaction will be proportional to the viability of the reactant.

    \subsubsection{Value of the propensity}
    The propensity $a_j(X(T))$ is a function of the state $X(t)$.
    The fact that $a_j$ of a reaction depends on time $t$ happens implicitly through the Markovian assumptions.
    At a particular time $t$, the value of the propensity $a_j(X(T))$ is a deterministic quantity.
    The propensity value of a reaction in state $X(t)$ is often used as a measure of how fast the reaction proceeds to move to a new state.
    Let $\mathcal{P}\{R_j\text{ fires }\in [t,t+dt[\}$ be the probability that reaction $R_j$ fires in the time interval.
    Given the state $X(t)=\vec{x}$ at time $t$, then:

    $$\mathcal{P}\{R_j\text{ fires }\in [t,t+dt[\} = a_j(\vec{x})dt + o(dt)$$

    Where $o(dt)$ expresses that it asymptotically approaches zero faster than $dt$: $\lim\limits_{dt\rightarrow 0} \frac{o(dt)}{dt} = 0$.
    In other words the probability that there are more than one firing of $R_j$ in the time step i in order of $o(dt)$ and so it is negligible.
    The propensity of a reaction is an intrinsic property of the reaction and is linked to the phenomenon that the reaction is going to represent.
    The probability will depend on the propensity of the reaction and the other reactions that are competing for the same reactant.
    The propensity is not affected by the products.

    $$a_1 (0) = c_1 h_1 (x(0))$$

    $$h_2(x(0)) = \begin{pmatrix}100 \\ 1 \end{pmatrix}\begin{pmatrix}50 \\ 1 \end{pmatrix}\begin{pmatrix}30 \\ 0 \end{pmatrix}$$

    $$x(0+ \tau) = x(0) + V_1 = \begin{bmatrix}99 &51& 30 \end{bmatrix}$$

    $$x(0) = \begin{bmatrix}100 &50& 30 \end{bmatrix}$$

    Since the combination is being computed $a^2$ will not be taken into account as in the canonical law of mass action.


    \subsubsection{Mass action propensity}
    A precise formula for the propensity function $a_j$ is dependent on the kinetics and a specific assumption about how the reaction occurs physically.
    This is referred as the fundamental premise of the stochastic chemical kinetics.
    For the standard mass action kinetics, the propensity $a_j$ of reaction $R_j$ is proportional to a stochastic reaction rate $c_j$ and the number of its reactants.
    So given current state $X(t)$ at time $t$:

    $$a_j(X(t)) = c_jh_j(X(t))$$

    Where $c_j$ is the stochastic reaction rate and $h_j(X(t))$ counts the number of distinct combination of reactants:

    $$h_j(X(t)) = \prod\limits_i\binom{X_i(t)}{v_{ji}^-} = \prod\limits_i\frac{X_i(t)!}{v_{ij}^0!(X_i(t)-v_{ij}^-)!}$$

    In the case of a synthesis reaction, where the stoichiometric coefficient of its reactants is $0$ is set to $h_j(X(t)) = 1$.

      \paragraph{The stochastic rate}
      The stochastic rate $c_j$ denotes the average probability per unit time that a particular combination of reactant molecules of reaction $R_j$ reacts in the volume $V$ and depends on the reaction type.
      In the case of a unimolecular reaction is independent of the volume size, while in the case of a bimolecular one it will be inversely proportional of it.
      The rate is constant provided that:

      \begin{multicols}{2}
        \begin{itemize}
          \item The volume $V$ is constant.
          \item The volume is well-mixed.
          \item The volume is thermally homogeneous.
        \end{itemize}
      \end{multicols}

    \subsubsection{Reaction propensity for reactions $ R_j$ with mass action kinetics}
    From now $X_i$ will be used in place of $X_i(t)$, when $t$ is irrelevant or clear from the context.
    Some reaction will be described by mass action kinetics by:

    \begin{itemize}
      \item Synthesis reaction ($\emptyset$ → products): the number of combinations $ h_j = 1 $ and propensity $ a_j =c_j $
      \item Unimolecular reaction ($ S_i$ → products): the number of combinations $h_j= X_i$ and propensity $ a_j = c_jX_i $.
      \item Bimolecular reaction ($ S_i + S_k$ → products): the number of combinations $ h_j = X_iX_k$ and propensity $ a_j = c_jX_iX_k $.
      \item Dimerization reaction ($2S_i$ → products): the number of combinations $ h_j = \frac{1}{2}X_i(X_i -1) $ and propensity $ a_j = \frac{1}{2}c_jX_i(X_i -1) $.
      \item Polymerization reaction ($3S_i$ → products): the number of combinations $ h_j = 16X_i(X_i -1)(X_i -2)$ and propensity $ a_j = 16c_jX_i(X_i -1)(X_i -2) $.
      \item Termolecular reaction ($2S_i + S_k$ → products): the number of combinations $ h_j = \frac{1}{2}X_i(X_i -1)X_k$ and propensity $ a_j = \frac{1}{2}c_jX_i(X_i -1)X_k $.
    \end{itemize}

    \subsubsection{Complex reaction kinetics}
    Complex reaction kinetics can be used.
    The propensity $a_j$ will show a complicated, non-linear dependence on the chemical species and may contain more than one rate constant.

      \paragraph{Michaelis-Menten kinetics}
      The Michaelis-Menten kinetics is used to approximate the mechanism of enzymatic reaction.
      Consider an enzymatic reaction $R_j$ with form:

      $$S_i+S_k \rightarrow S_i + S_j$$

      Where:

      \begin{multicols}{2}
        \begin{itemize}
          \item $S_k$ is the substrate.
          \item $S_i$ is the enzyme.
        \end{itemize}
      \end{multicols}

      The reaction propensity will be defined as:

      $$a_j = \frac{V_{\max}}{K_M+x_k}X_iX_k$$

      Where:

      \begin{multicols}{2}
        \begin{itemize}
          \item $V_{\max}$ is the maximum rate such that the substrate $S_k$ is saturated.
          \item  $K_m$  or Michaelis constant is the substrate concentration at which the reaction rate is half of $V_{\max}$.
        \end{itemize}
      \end{multicols}

  \subsection{Chemical Master Equation}
  The chemical master equation or CME is the theoretical approach allowing to derive the complete set of probabilities of all the possible states of the system.
  Suppose that the biochemical reaction system starts with an initial state $X(t_0) = \vec{x}_0$.
  Let $t>t_0$ and the system at state $X(t)=\vec{x}$,
  The purpose of the stochastic chemical kinetics is to infer the probability:

  $$\mathbb{P}\{\vec{x},t|\vec{x}_0, t_0\}$$

    \subsubsection{Grand probability function}
    The probability function or grand probability:

    $$\mathbb{P}\{\vec{x},t|\vec{x}_0,t_0\}$$

    Is the probability that the system state is $X(t) = \vec{x}$ at time $t$, given the initial state $X(t_0) = \vec{x}_0$ at time $t_0$.
    It is called so because it gives the probabilities of all reachable states of the system at time $t$ given the initial state.
    Knowing it all the statistical properties can be computed for every species at any time.

    \subsubsection{Deriving the chemical master equation}
    To derive the time evolution of the grand probability, consider an infinitesimal time interval $[t, t+ dt[$ so that there is at most one reaction in that interval.
    Suppose that at time $t+dt$ the system state is $X(t+dt) = \vec{x}$.
    There are two cases in order to reach the state $\vec{x}$ in the time-step given the current time:

    \begin{multicols}{2}
      \begin{itemize}
        \item At time $t$ the state is $X(t) = \vec{x}-\vec{v}_j$ and reaction $R_j$ fires in the next time step leading to $X(t+dt) = \vec{x}$.
        \item At time $t$ the state is already $X(t)=\vec{x}$ and no reaction fires in the time step.
      \end{itemize}
    \end{multicols}

      Then the grand probability can be written as:

      \begin{align*}
        \mathbb{P}\{\vec{x}, t+dt|\vec{x}_0, t_0\} =& \sum\limits_{j=1}^M\mathbb{P}\{R_j\text{ fires }\in[t, t+dt[\}\mathbb{P}\{\vec{x}-\vec{v}_j, t|\vec{x}_0, t_0\} +\\
                                                    &+\mathbb{P}\{\text{No reaction fires }\in[t, t+dt[\}\mathbb{P}\{\vec{x}, t|\vec{x}_0, t_0\}
      \end{align*}

      Note that when the state vector $\vec{x}-\vec{v}$ gives negative populations, the probability $\mathbb{P}\{\vec{x}-\vec{v}_j, t|\vec{x}_0, t_0\}$ is zero because the populations of species must be positive.
      Now, the probability that no reaction fires in the time-step can be computed as:

      \begin{align*}
        \mathbb{P}\{\text{No reaction fires }\in[t,t+dt[\} &=\prod\limits_{j=1}^M(1-\mathbb{P}\{R_j\text{ fires }\in[t, t+dt[\}) =\\
                                                           &=\prod\limits_{j=1}^M(1-a_j(\vec{x})dt+o(dt))=\\
                                                           &=1-\prod\limits_{j=1}^M a_j(\vec{x})dt+o(dt)
      \end{align*}

      Then substituting the definition of the probability of a reaction firing and the probability of a reaction non firing just computed into the grand probability function:

      \begin{align*}
        \mathbb{P}\{\vec{x}, t+dt|\vec{x}_0, t_0\} =& \sum\limits_{j=1}^M\mathbb{P}\{\vec{x}-\vec{v}_j, t|\vec{x}_0, t_0\}(a_j(\vec{x}-\vec{v}_j)dt + o(dt)) +\\
                                                    &+\mathbb{P}\{\vec{x}, t|\vec{x}_0, t_0\}\left(1-\sum\limits_{j=1}^Ma_j(\vec{x})dt+o(dt)\right)
      \end{align*}

      Subtracting $\mathbb{P}\{\vec{x}, t|\vec{x}_0, t_0\}$ from both sides, dividing by $dt$ and considering the limit $dt\rightarrow 0$, the chemical master equation is obtained:

    $$\frac{\mathbb{P}\{\vec{x},t|\vec{x}_0,t_0\}}{dt}= \sum_{j=1}^{M}(a_j(\vec{x}-\vec{v}_j)\mathbb{P}\{\vec{x},t|\vec{x}_0,t_0\})- \mathbb{P}\{\vec{x},t|\vec{x}_0,t_o\}\sum^M_{j=1}a_j(\vec{x})$$

    The chemical master equation is a collection of differential equations in which each of them represents the probability of each possible state of the system at time $t$.
    It provides a complete description of the time evolution of the grand probability:

    $$\mathbb{P}\{\vec{x}, t|\vec{x}_0, t_0\}$$


    \subsubsection{Limitations of the chemical master equation}
    The chemical master equation allows to compute the probabilities of all possible states at any time, however directly solving it require a lot of computational challenges:

    \begin{multicols}{2}
      \begin{itemize}
        \item An analytical or numerical approach to solve CME in general is non-trivial to find.
        \item There is a huge number of differential equations: $a^N$, where $N$ is the number of species and $a$ is the values of the population of each species.
      \end{itemize}
    \end{multicols}

    So it can be seen how the number of differential equations increases exponentially, making the state space explode in dimension, preventing direct approaches in solving CMEs.

\section{Stochastic simulation}
When applying the CME, all the possible state of the system are explored.
With a stochastic simulation only one possible trajectory of the system is computed (to obtain the total description many simulations have to be run).
The stochastic simulation works because only an idea of the most probable conditions of the system is needed.
A stochastic simulation is faster than a real experiment and it can be run on a personal computer (also thousands of simulations can be performed).
One of the crucial points of a stochastic simulation is that there is a need to be able to sample from this probability distribution  function given the fact that the computer has few ways of generating something that is stochastic.
The easiest way to do so is through a random number generator.

  \subsection{Probability density function}
  Stochastic simulations are an alternative approach to solve CME by producing possible realization of the grand probability function.
  It only explores possible states in the state space each time, so they can handle the biochemical reactions with very high-dimensional state space.
  The mathematical basis of a stochastic simulation is the reaction probability density function pdf:

  $$p(\tau, \mu|\vec{x}, t)$$

  Which is defined such that $p(\tau, \mu |\vec{x}, t)d\tau$ is the probability that a reaction $R_\mu$ fires in the next infinitesimal time interval $[t+\tau,t+\tau+d\tau[$, given the state $X(t) = \vec{x}$ at time $t$.
  The pdf $p(\tau, \mu|\vec{x}, t)$ is a joint distribution of two variables showing the index $\mu$ of the reaction firing $R_\mu$ at time $\tau$ of the firing respectively, knowing that the system is at state $X(t)$ at time $t$.
  The reaction index $\mu$ will vary from $1\le\mu\le M$, while the next time $\tau$ will vary from $0\le \tau\le\infty$.


    \subsubsection{Computing the probability density function}
    The probability $p(\tau, \mu|\vec{x}, t)dt$ can be computed as the product of:

    \begin{multicols}{2}
      \begin{itemize}
        \item The probability that no reaction fires in the time interval $[t, t+\tau[$.
        \item The probability that a reaction $R_\mu$ fires in the next infinitesimal interval $[t+\tau, t+\tau+d\tau[$.
      \end{itemize}
    \end{multicols}

    Let:

    \begin{multicols}{2}
      \begin{itemize}
        \item $\mathbb{P}\{\text{No reaction fires }\in[t,t+\tau[\}$ be the probability that no reaction fires in the time interval $[t, t+\tau[$.
        \item $\mathbb{P}\{R_\mu\text{ fires }\in[t+\tau, t+\tau+d\tau[\}$ be the probability that reaction $R_\mu$ fires in the next infinitesimal time interval $[t+\tau, t+\tau+d\tau[$.
      \end{itemize}
    \end{multicols}

    Then:

    $$p(\tau, \mu|\vec{x}, t) d\tau = \mathbb{P}\{\text{No reaction fires }\in[t,t+\tau[\}\mathbb{P}\{R_\mu\text{ fires }\in[t+\tau, t+\tau+d\tau\}$$

    To compute the probability that no reaction fires the time interval is divided into $k$ non overlapping sub interval of length $\epsilon = \frac{k}{\tau}$.
    The probability that no reaction fires in the i-th interval $[t+(i-1)\epsilon, t+i\epsilon[\forall i=1,\dots,k$ is:

    $$\mathbb{P}\{\text{No reaction fires }\in[t+(i-1)\epsilon, t+i\epsilon[\} = 1-\sum\limits_{j=1}^Ma_j(\vec{x})\epsilon+o(\epsilon)$$

    Hence the probability that no reaction fires in $[t, t+\tau[$ is the product of the probabilities that no reaction fires in $k$ non-overlapping intervals:

    \begin{align*}
      \mathbb{P}\{\text{No reaction fires }\in[t,t+\tau[\} &= \prod\limits_{i=1}^k\mathbb{P}\{\text{No reaction fires }\in[t+(i-1)\epsilon, t+i\epsilon[\}=\\
                                                           &=\prod\limits_{i=1}^k\left(1-\sum\limits_{j=1}^Ma_j(\vec{x})\epsilon+o(\epsilon)\right)=\\
                                                           &=\left(1-\sum\limits_{j=1}^Ma_j(\vec{x})\epsilon+o(\epsilon)\right)^k=\\
                                                           &=(1-a_0(\vec{x})\epsilon+o(\epsilon))^k
    \end{align*}

    Where $a_0(\vec{x})$ is the total propensity defined as:

    $$a_0(\vec{x}) = \sum\limits_{j=1}^Ma_j(\vec{x})$$

    In the limit case where $k\rightarrow\infty$:

    \begin{align*}
      \mathbb{P}\{\text{No reaction fires }\in[t,t+\tau[\} &= \lim\limits_{k\rightarrow\infty}(1-a_0(\vec{x})\epsilon+o(\epsilon))^k =
                                                           &=\lim\limits_{k\rightarrow\infty}\left(1-\frac{a_0(\vec{x})k\epsilon+ko(\epsilon)}{k}\right)^k=\\
                                                           &=\lim\limits_{k\rightarrow\infty}\left(1-\frac{a_0(\vec{x})\tau+\tau(\frac{o(\epsilon)}{\epsilon}}{k}\right)^k=\\
                                                           &=e^{-a_0(\vec{x})\tau}
    \end{align*}

    The last step is true because:

    \begin{multicols}{2}
      \begin{itemize}
        \item $\frac{o(\epsilon)}{\epsilon}\rightarrow 0$ when $k\rightarrow\infty$.
        \item $\lim\limits_{k\rightarrow\infty}\left(1-\frac{a_0(\vec{x})\tau}{k}\right)^k = e^{-a_0(\vec{x})\tau}$.
      \end{itemize}
    \end{multicols}

    The probability that a reaction fires, following the definition of the reaction propensity is computed by:

    $$\mathbb{P}\{R_\mu\text{ fires }\in[t+\tau, t+\tau+d\tau[\} = a_\mu(\vec{x})d\tau+o(d\tau)$$

    Now plugging everything in the definition of the probability:

    $$p(\tau, \mu|\vec{x}, t)d\tau = e^{-a_0(\vec{x})\tau}(a_\mu(\vec{x})d\tau+o(d\tau))$$

    Dividing both sides by $d\tau$ and taking the limit $d\tau\rightarrow\infty$ and remembering that $\frac{o(d\tau)}{d\tau} \rightarrow 0$, the pdf will have the formula:

    $$p(\tau, \mu|\vec{x},t) = a_\mu(\vec{x})e^{-a_o(\vec{x}\tau)}$$

    Which is the joint probability density function of the next reaction index $\mu$ and the next firing time $\tau$ over their domains.
    This can be verified as:

    $$\int_0^\infty d\tau\sum\limits_{\mu=1}^Mp(\tau, \mu|\vec{x}, t) = \sum\limits_{\mu=1}^Ma_\mu(\vec{x})\int_0^\infty d\tau e^{-a_0(\vec{x})\tau} = 1$$

    The pdf depends on the propensities of all reaction as well as on all species.

  \subsection{Stochastic simulation algorithm}

  $$p(\tau, \mu|\vec{x},t) = a_\mu(\vec{x})e^{-a_o(\vec{x}\tau)}$$

  Is the framework for a class of exact Monte Carlo simulation techniques originating from the stochastic simulation algorithm or SSA.
  It is a discrete event simulation: the state is updated by a random selected reaction $R_\mu$ and a discrete time $\tau$ sampled from the pdf.
  It exactly generates $\mu$ of the reaction and the firing time $\tau$ without introducing approximation in sampling the pdf.
  A general sketch of the SSA procedure is outlined in algorithm \ref{algo:ssa-sketch}.

  \input{chapters/02/algorithms/01_ssa-sketch}

  For each iteration in the while loop the algorithm computes the propensity $a_j$ for each reaction and the total propensity.
  The next reaction $R_\mu$ and its firing time $\tau$ are sampled from the pdf, a step that may need the generation of randomly distributed random numbers.
  The state is updated and the time is advanced to $t=t+\tau$.
  The loop is repeated until $t>T_{\max}$.
  The propensities are updated at each iteration to reflect changes in the populations of species caused by reaction firings, but this can be skipped by employing an appropriate sampling technique.
  The result of the algorithm is a trajectory, that shows the evolution of the biological system over time.
  This is a collection of states $X(t)$ that denotes the state of the system at any time $0\le t\le T_{max}$.
  It should be emphasized that because SSA is a discrete event simulation algorithm, the state changes only at discrete time instants when reactions fire.
  The state between two reaction firings is a constant.

\section{Simulation output analysis}
The trajectory obtained from a SSA run represents a possible realization of the grand probability $\mathbb{P}\{\vec{x},t|\vec{x}_0, t_0\}$.
Many independent run started with the same initial conditions are needed to have a reasonable statistical estimation.

  \subsection{Confidence interval estimation}
  Let $K$ be the number of simulation and $\vec{X}^r$, with $r = 1, \dots, K$ be a realization of the state $\vec{X}$ obtained at time $t$ by the r-th independent run of SSA.
  The statistical properties can be derived from the ensemble of the trajectories, that are ensured to approach the exact solution of the CME as $K\rightarrow\infty$.
  Let $\langle \vec{X}\rangle$ be the sample mean and $s^2$ the unbiased variance.
  They are computed as:

  $$\langle\vec{X}\rangle = \frac{\sum\limits_{r=1}^K\vec{X}^r}{K}\qquad s^2=\frac{\sum\limits_{r=1}^K(\vec{X}^r-\langle\vec{x}\rangle)^2}{K-1}$$

  The sample mean and variance will approach the mean and variance of the random variable $\vec{X}$ when $K$ tends to infinity:

  $$\mathbb{E}[\vec{X}] = \lim\limits_{K\rightarrow\infty}\langle\vec{X}\rangle\qquad Var[\vec{X}] = \lim\limits_{K\rightarrow\infty}s^2$$

  The convergence of the estimation is measured by the size of the confidence interval as the number of simulation runs is limited:

  $$d = \frac{zs}{\sqrt{K}}$$

  Where $z$ is a confidence interval, denoting the percentage of the range of estimated values expected to include the true value.
  When it is fixed, the probability that the mean lies in the interval $[\langle\vec{x}\rangle-d, \langle\vec{x}\rangle+d]$ is $2\phi(z)-1$, where $\phi$ is the cumulative distribution function or cdf of the normal distribution $norm(0,1)$.
  The required number of simulation runs to achieve a specified confidence interval size can be computed:

  $$K = \frac{z^2s^2}{d^2}$$

  $K$ depends reciprocally on the square of the confidence interval size $d$ and on the sample variance $s^2$, which is unknown.
  One approach to circumvent this problem is to perform first a small number of trial runs to estimate $s_{trial}^2$, which is applied to compute the number of simulation runs necessary:

  $$K = \frac{z^2s_{trial}^2}{d^2}$$

  \subsection{Probability distribution equation}
  Bistability is a form of multistablity where two separated stable equilibrium points are separated by an unstable equilibrium, the average population of species might not provide enough information for their dynamical behaviour.
  The probability distribution must be used to quantitatively analyse the simulation results.
  The probability distribution can be estimated by using the histogram or empirical distribution function of the samples.
  It is ensured to converge to the exact probability distribution given a large number of simulation runs $K$.
  The following assumes $X$ to be a scalar value, but it can be easily extended to the general case.
  To compute the histogram the state $X$ at time $t$ obtained by $K$ simulation runs of SSA is supposed to be bounded into an interval $[X_{\min}, X_{\max}]$, chosen arbitrarily.
  Then the interval is divided into $B$ bins, such that the i-th bin $I_i$ is defined as the subinterval:

  $$\left[X_{\min}+\frac{(i-1)L}{B}, X_{\min}+\frac{iL}{B}\right]$$

  Where $L=X_{\max}-X_{\min}$.
  The histogram $h_X$ of state $X$ is then defined as:

  $$h_X(I_i) = \frac{B}{KL}\sum\limits_{r=1}^K\mathcal{X}(X^r,I_i)$$

  Where $X^r$ is the realization of $X$ by the r-th simulation and $\mathcal{X}(X^r, I_i)$ is defined as:

  $$\mathcal{X}(X^r, I_i) = \begin{cases}1 &X^r\in I_i\\0 & otherwise\end{cases}$$

  The histogram therefore gives the average probability of $X$ in interval $I_i$.
  Let now $p_X$ be the probability distribution of state $X$.
  When $K\rightarrow\infty$ and $B\rightarrow\infty$, $I_i$ reduces to a point and $h_X$ converges to $p_X$ at this point.
  Formally:

  $$p_X = \lim\limits_{K,B\rightarrow\infty}h_X$$
